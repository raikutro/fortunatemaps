const gridElem = document.getElementById("chunkGrid");
const remainingElem = document.getElementById("chunkRemaining");
const dailyLimitElem = document.getElementById("chunkDailyLimit");
const generateBtn = document.getElementById("generateChunkBtn");
const messageElem = document.getElementById("chunkMessages");

let chunkState = {
	remaining: (window.CHUNK_DATA && window.CHUNK_DATA.remaining) || 0,
	dailyLimit: (window.CHUNK_DATA && window.CHUNK_DATA.dailyLimit) || 0,
	perRequest: (window.CHUNK_DATA && window.CHUNK_DATA.perRequest) || 4
};

function renderStatus() {
	remainingElem.textContent = chunkState.remaining;
	dailyLimitElem.textContent = chunkState.dailyLimit;
}

function setMessage(type, text) {
	messageElem.innerHTML = text ? `<div class="alert alert-${type} mb-0">${text}</div>` : "";
}

async function renderMaps(maps) {
	gridElem.innerHTML = "";

	const previewTasks = maps.map(async (map, idx) => {
		const col = document.createElement("div");
		col.className = "col-12 col-md-6 mb-3";

		const card = document.createElement("div");
		card.className = "card h-100";

		const img = document.createElement("img");
		img.className = "card-img-top";
		img.alt = `CHUNK v1 Preview ${idx + 1}`;
		img.src = `data:image/png;base64,${map.png}`;

		const body = document.createElement("div");
		body.className = "card-body";
		body.innerHTML = `
			<h5 class="card-title">CHUNK v1 Map ${idx + 1}</h5>
			<p class="card-text small mb-0">Generated by the CHUNK v1 algorithm.</p>
		`;

		const footer = document.createElement("div");
		footer.className = "card-footer d-flex justify-content-between";
		footer.innerHTML = `
			<a class="btn btn-outline-primary btn-sm" download="chunkv1_map_${idx + 1}.png" href="data:image/png;base64,${map.png}">Download PNG</a>
			<a class="btn btn-outline-secondary btn-sm" download="chunkv1_map_${idx + 1}.json" href="data:application/json;base64,${map.json}">Download JSON</a>
		`;

		card.appendChild(img);
		card.appendChild(body);
		card.appendChild(footer);
		col.appendChild(card);
		gridElem.appendChild(col);

		try {
			const canvas = await buildPreviewFromAssets(map);
			if(canvas) img.src = canvas.toDataURL("image/jpeg", 0.9);
		} catch (err) {
			console.error("Failed to render CHUNK preview", err);
		}
	});

	await Promise.all(previewTasks);
}

async function buildPreviewFromAssets(map) {
	if(!window.GENERATE_MAP_PREVIEW) return null;
	const image = await loadImage(`data:image/png;base64,${map.png}`);
	const mapJSON = parseMapJSON(map.json);
	if(!mapJSON) return null;
	return window.GENERATE_MAP_PREVIEW(image, mapJSON);
}

function loadImage(src) {
	return new Promise((resolve, reject) => {
		const img = new Image();
		img.onload = () => resolve(img);
		img.onerror = reject;
		img.src = src;
	});
}

function parseMapJSON(b64) {
	try {
		const jsonStr = atob(b64);
		return JSON.parse(jsonStr);
	} catch (err) {
		console.error("Failed to parse CHUNK map JSON", err);
		return null;
	}
}

async function generateMaps() {
	setMessage("info", "Generating mapsâ€¦");
	generateBtn.disabled = true;

	try {
		const res = await fetch("/chunkv1/generate", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
				"X-CSRF-Token": getCsrfToken()
			}
		});

		const json = await res.json();

		if(!res.ok) {
			setMessage("danger", json.err || "Failed to generate maps.");
			return;
		}

		chunkState.remaining = json.remaining;
		chunkState.dailyLimit = json.dailyLimit;
		renderStatus();
		renderMaps(json.maps || []);
		setMessage("success", `Generated ${(json.maps || []).length} map(s).`);
	} catch (err) {
		setMessage("danger", "Unexpected error generating maps.");
	} finally {
		generateBtn.disabled = false;
	}
}

renderStatus();
generateBtn.addEventListener("click", generateMaps);
